diff --git a/ffmpeg.c b/ffmpeg.c
index dba6089..b67a8c4 100644
--- a/ffmpeg.c
+++ b/ffmpeg.c
@@ -3360,7 +3360,7 @@ static int transcode(void)
 
 static int64_t getutime(void)
 {
-#if HAVE_GETRUSAGE
+#if HAVE_GETRUSAGE && !defined(__native_client__)
     struct rusage rusage;
 
     getrusage(RUSAGE_SELF, &rusage);
@@ -3378,7 +3378,7 @@ static int64_t getutime(void)
 
 static int64_t getmaxrss(void)
 {
-#if HAVE_GETRUSAGE && HAVE_STRUCT_RUSAGE_RU_MAXRSS
+#if HAVE_GETRUSAGE && HAVE_STRUCT_RUSAGE_RU_MAXRSS && !defined(__native_client__)
     struct rusage rusage;
     getrusage(RUSAGE_SELF, &rusage);
     return (int64_t)rusage.ru_maxrss * 1024;
diff --git a/libavcodec/libvpxenc.c b/libavcodec/libvpxenc.c
index 8ebf052..c665125 100644
--- a/libavcodec/libvpxenc.c
+++ b/libavcodec/libvpxenc.c
@@ -289,7 +289,7 @@ static av_cold int vpx_init(AVCodecContext *avctx,
     if (avctx->rc_min_rate == avctx->rc_max_rate &&
         avctx->rc_min_rate == avctx->bit_rate && avctx->bit_rate)
         enccfg.rc_end_usage = VPX_CBR;
-    else if (ctx->crf)
+    else if (ctx->crf || avctx->bit_rate == 0)
         enccfg.rc_end_usage = VPX_CQ;
 
     if (avctx->bit_rate) {
